<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=0.85" />
  <title>Dashboard Portefeuille</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f7fa;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1, h2 { text-align: center; }
    .controls, table {
      max-width: 1000px;
      width: 100%;
      margin: 20px 0;
    }
    .controls input, .controls select, .controls button {
      padding: 10px;
      margin: 5px;
      width: 100%;
    }
    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
    }
    table {
      border-collapse: collapse;
      background: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th { background: #eee; }
    .gain { color: green; }
    .perte { color: red; }
    #globalPerf {
      font-weight: bold;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>Dashboard Portefeuille</h1>
  <div class="controls">
    <select id="type">
      <option value="crypto">Crypto</option>
      <option value="action">Action</option>
    </select>
    <input id="symbol" placeholder="Symbole (ex: bitcoin, AAPL)" />
    <input id="quantity" type="number" placeholder="Quantité" />
    <input id="invested" type="number" placeholder="Investi" />
    <select id="devise">
      <option value="cad">CAD</option>
      <option value="usd">USD</option>
    </select>
    <button onclick="addAsset()">Ajouter</button>
    <input id="removeSymbol" placeholder="Symbole à supprimer (ex: BTC ou AAPL)" />
    <button onclick="removeAsset()">Supprimer</button>
    <button onclick="refreshAll()">Actualiser maintenant</button>
  </div>

  <div id="globalPerf"></div>
  <h2>Actions</h2>
  <table>
    <thead>
      <tr><th>Symbole</th><th>Qté</th><th>Investi</th><th>Prix</th><th>Valeur</th><th>Variation</th><th>Devise</th></tr>
    </thead>
    <tbody id="tableAction"></tbody>
  </table>

  <h2>Cryptos</h2>
  <table>
    <thead>
      <tr><th>Symbole</th><th>Qté</th><th>Investi</th><th>Prix</th><th>Valeur</th><th>Variation</th><th>Devise</th></tr>
    </thead>
    <tbody id="tableCrypto"></tbody>
  </table>

  <h2>Opportunités du moment</h2>
  <ul id="opportunities"></ul>

  <h2>Conseils personnalisés</h2>
  <ul id="adviceList"></ul>
  <script>
  const ALPHA_KEY = 'W9V75CXC1GIZ3HFX';
    // Pause entre appels API (utile pour Alpha Vantage)
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}
// Forcer tous les actifs dans le portefeuille
    let portfolio = JSON.parse(localStorage.getItem('portfolio')) || [
  // Actions
  { type: 'action', sym: 'AAPL', qty: 1.2, inv: 300, curr: 'usd' },
  { type: 'action', sym: 'TSLA', qty: 0.8, inv: 250, curr: 'usd' },
  { type: 'action', sym: 'NVDA', qty: 0.5, inv: 280, curr: 'usd' },
  { type: 'action', sym: 'CRM', qty: 0.2271, inv: 57.97, curr: 'usd' },
  { type: 'action', sym: 'GLD', qty: 0.2022, inv: 59.99, curr: 'usd' },
  { type: 'action', sym: 'SLV', qty: 1.0, inv: 29.45, curr: 'usd' },

  // Cryptos
  { type: 'crypto', sym: 'bitcoin', qty: 0.02, inv: 800, curr: 'cad' },
  { type: 'crypto', sym: 'ethereum', qty: 0.1, inv: 350, curr: 'cad' },
  { type: 'crypto', sym: 'solana', qty: 0.988, inv: 180.00, curr: 'cad' },
  { type: 'crypto', sym: 'chainlink', qty: 4.9401, inv: 90.00, curr: 'cad' },
  { type: 'crypto', sym: 'cardano', qty: 89.6204, inv: 80.00, curr: 'cad' },
  { type: 'crypto', sym: 'polkadot', qty: 13.3732, inv: 70.00, curr: 'cad' },
  { type: 'crypto', sym: 'avalanche-2', qty: 1.7365, inv: 50.00, curr: 'cad' },
  { type: 'crypto', sym: 'pepe', qty: 2.89275, inv: 30.00, curr: 'cad' }
];

async function fetchCrypto(sym) {
  const url = `https://api.coingecko.com/api/v3/simple/price?ids=${sym}&vs_currencies=cad&include_24hr_change=true`;
  try {
    const res = await fetch(url);
    const data = await res.json();
    if (!data[sym]) {
      console.warn("Crypto non trouvée CoinGecko:", sym);
      return null;
    }
    return {
      price: data[sym].cad,
      change: data[sym].cad_24h_change
    };
  } catch (e) {
    console.error("Erreur CoinGecko:", sym, e);
    return null;
  }
    }

async function fetchAction(sym) {
  const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${sym}&apikey=${ALPHA_KEY}`;
  try {
    const res = await fetch(url);
    const data = await res.json();
    if (data.Note) {
      console.warn("Trop de requêtes pour Alpha Vantage (attente nécessaire)");
      return null;
    }
    const g = data["Global Quote"];
    if (!g || !g["05. price"]) {
      console.warn("Action inconnue:", sym);
      return null;
    }
    return {
      price: parseFloat(g["05. price"]),
      change: parseFloat(g["10. change percent"])
    };
  } catch (e) {
    console.error("Erreur Alpha:", sym, e);
    return null;
  }
}

  async function refreshAll() {
    const tbodyA = document.getElementById("tableAction");
    const tbodyC = document.getElementById("tableCrypto");
    const advice = document.getElementById("adviceList");
    const perf = document.getElementById("globalPerf");

    tbodyA.innerHTML = "";
    tbodyC.innerHTML = "";
    advice.innerHTML = "";

    let inv = 0, val = 0;

  for (let a of portfolio) {
  if (a.type === 'action') await sleep(15000); // Attente de 15s pour éviter blocage Alpha Vantage
      const info = a.type === 'crypto'
        ? await fetchCrypto(a.sym)
        : await fetchAction(a.sym.toUpperCase());
      console.log("Chargement:", a.sym, "→", info);
      if (!info) {
  const row = `<tr>
    <td>${a.sym.toUpperCase()}</td>
    <td>${a.qty}</td>
    <td>${a.inv.toFixed(2)}</td>
    <td colspan="4" style="color:red">Données indisponibles</td>
  </tr>`;
  if (a.type === 'crypto') tbodyC.innerHTML += row;
  else tbodyA.innerHTML += row;
  continue;
      }
      const value = info.price * a.qty;
      const gain = value - a.inv;
      const change = info.change.toFixed(2);
      const gainClass = gain >= 0 ? 'gain' : 'perte';

      inv += a.inv;
      val += value;

      const row = `<tr><td>${a.sym.toUpperCase()}</td><td>${a.qty}</td><td>${a.inv.toFixed(2)}</td><td>${info.price.toFixed(2)}</td><td>${value.toFixed(2)}</td><td class="${gainClass}">${change}%</td><td>${a.curr.toUpperCase()}</td></tr>`;
      if (a.type === 'crypto') tbodyC.innerHTML += row;
      else tbodyA.innerHTML += row;

      advice.innerHTML += `<li><strong>${a.sym.toUpperCase()}</strong> : ${gain >= 20 ? 'Vendre' : gain <= -15 ? 'À risque' : 'Garder'}</li>`;
    }

    const totalGain = val - inv;
    const totalPct = inv ? (totalGain / inv * 100).toFixed(2) : 0;
    perf.textContent = `Performance globale : ${totalGain.toFixed(2)} CAD (${totalPct}%)`;
    perf.style.color = totalGain >= 0 ? 'green' : 'red';

    fetchOpportunities();
  }

  async function fetchOpportunities() {
    const ul = document.getElementById("opportunities");
    ul.innerHTML = '';
    try {
      const res = await fetch("https://api.coingecko.com/api/v3/coins/markets?vs_currency=cad&order=price_change_percentage_24h_desc&per_page=5&page=1");
      const data = await res.json();
      data.forEach(c => {
        ul.innerHTML += `<li>${c.name} (${c.symbol.toUpperCase()}) : +${c.price_change_percentage_24h.toFixed(2)}%</li>`;
      });
    } catch {
      ul.innerHTML = '<li>Erreur de récupération</li>';
    }
  }

  function addAsset() {
    const type = document.getElementById('type').value;
    const symInput = document.getElementById('symbol').value.trim();
    const qty = parseFloat(document.getElementById('quantity').value);
    const inv = parseFloat(document.getElementById('invested').value);
    const curr = document.getElementById('devise').value;

    if (!symInput || !qty || !inv) return alert('Tous les champs sont requis.');

    const sym = type === 'crypto' ? symInput.toLowerCase() : symInput.toUpperCase();
    portfolio.push({ type, sym, qty, inv, curr });
    refreshAll();
  }

  function removeAsset() {
    const sym = document.getElementById('removeSymbol').value.trim().toLowerCase();
    const lenBefore = portfolio.length;
    portfolio = portfolio.filter(a => a.sym.toLowerCase() !== sym);
    if (portfolio.length === lenBefore) {
      alert('Aucun actif trouvé pour ce symbole.');
    } else {
      alert(`Actif ${sym.toUpperCase()} supprimé.`);
      refreshAll();
    }
  }

  window.onload = refreshAll;
</script>
