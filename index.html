<!DOCTYPE html><html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Portefeuille</title>
  <!-- OneSignal SDK -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; background: #f0f2f5; }
    .container { max-width: 800px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    h1 { text-align: center; margin-bottom: 20px; }
    .controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    .controls > * { flex: 1 1 100%; }
    .controls select, .controls input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    .controls button { padding: 10px; background: #007bff; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    .controls button:hover { background: #0056b3; }
    #resumeGlobal { margin-bottom: 20px; font-size: 1.1em; }
    #lastUpdate { text-align: right; font-size: 0.9em; color: #666; margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: center; word-break: break-word; }
    th { background: #f7f7f7; }
    tr:nth-child(even) { background: #fafafa; }
    .gain { color: green; }
    .perte { color: red; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Dashboard Portefeuille</h1>
    <div class="controls">
      <button id="refreshNow">Actualiser maintenant</button>
      <select id="typeAsset">
        <option value="crypto_cad">Crypto (CAD)</option>
        <option value="crypto_usd">Crypto (USD)</option>
        <option value="action_usd">Action (USD)</option>
        <option value="action_cad">Action (CAD)</option>
      </select>
      <input id="symbol" type="text" placeholder="Symbole (bitcoin ou AAPL)">
      <input id="quantity" type="number" placeholder="Quantité" step="any">
      <input id="invested" type="number" placeholder="Montant investi" step="any">
      <button id="addAsset">Ajouter</button>
      <button id="removeAsset">Supprimer</button>
    </div>
    <div id="resumeGlobal"></div>
    <div id="lastUpdate"></div><h2>Cryptos</h2>
<table id="tableCrypto">
  <thead>
    <tr><th>Symbole</th><th>Qté</th><th>Investi</th><th>Prix Actuel</th><th>Valeur</th><th>Gain</th><th>%</th><th>Reco</th></tr>
  </thead>
  <tbody></tbody>
</table>

<h2>Actions / Métaux</h2>
<table id="tableAction">
  <thead>
    <tr><th>Symbole</th><th>Qté</th><th>Investi</th><th>Prix Actuel</th><th>Valeur</th><th>Gain</th><th>%</th><th>Reco</th></tr>
  </thead>
  <tbody></tbody>
</table>

<h2>Top Opportunités ≥20% (24h)</h2>
<table id="tableTop">
  <thead>
    <tr><th>Actif</th><th>Var. 24h %</th><th>Délai</th></tr>
  </thead>
  <tbody></tbody>
</table>

  </div>  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      await OneSignal.init({ appId: 'c5bd46ca-82c9-4493-b9a7-3813d3eccd03' });
    });

    document.addEventListener('DOMContentLoaded', () => {
      const ALPHA_KEY = 'W9V75CXC1GIZ3HFX';
      const CG_IDS = { sol:'solana', link:'chainlink', ada:'cardano', dot:'polkadot', avax:'avalanche-2', pepe:'pepe' };
      const defaultPortfolio = [
        {type:'action',sym:'GLD',qty:0.2022,inv:59.99,curr:'usd'},
        {type:'action',sym:'SLV',qty:1.0,   inv:29.45,curr:'usd'},
        {type:'action',sym:'CRM',qty:0.2271,inv:57.97,curr:'usd'},
        {type:'action',sym:'TSLA',qty:0.2822,inv:72.00,curr:'usd'},
        {type:'action',sym:'NVDA',qty:0.7767,inv:86.96,curr:'usd'},
        {type:'crypto',sym:'sol',qty:0.988, inv:180.00,curr:'cad'},
        {type:'crypto',sym:'link',qty:4.9401,inv:90.00,curr:'cad'},
        {type:'crypto',sym:'ada',qty:89.6204,inv:80.00,curr:'cad'},
        {type:'crypto',sym:'dot',qty:13.3732,inv:70.00,curr:'cad'},
        {type:'crypto',sym:'avax',qty:1.7365,inv:50.00,curr:'cad'},
        {type:'crypto',sym:'pepe',qty:2.89275,inv:30.00,curr:'cad'}
      ];

      let portfolio = JSON.parse(localStorage.getItem('portfolio'));
      if (!Array.isArray(portfolio) || portfolio.length === 0) {
        portfolio = defaultPortfolio;
        localStorage.setItem('portfolio', JSON.stringify(portfolio));
      }

      const tc = document.querySelector('#tableCrypto tbody');
      const ta = document.querySelector('#tableAction tbody');
      const tt = document.querySelector('#tableTop tbody');
      const res = document.getElementById('resumeGlobal');
      const last = document.getElementById('lastUpdate');

      const selType = document.getElementById('typeAsset');
      const inpSym  = document.getElementById('symbol');
      const inpQty  = document.getElementById('quantity');
      const inpInv  = document.getElementById('invested');

      document.getElementById('refreshNow').addEventListener('click', () => refreshAll());
      document.getElementById('addAsset').addEventListener('click', () => modifyAsset(true));
      document.getElementById('removeAsset').addEventListener('click', () => modifyAsset(false));

      async function fetchCrypto(sym, vs) {
        const id = CG_IDS[sym] || sym;
        const url = `https://api.coingecko.com/api/v3/simple/price?ids=${id}&vs_currencies=${vs}&include_24hr_change=true`;
        try { const j = await fetch(url).then(r => r.json()); return j[id] || {}; } catch { return {}; }
      }

      async function fetchAction(sym) {
        const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${sym}&apikey=${ALPHA_KEY}`;
        try { const j = await fetch(url).then(r => r.json()); const g = j['Global Quote'] || {}; return { price: parseFloat(g['05. price']) || 0, change: parseFloat(g['10. change percent']) || 0 }; } catch { return { price:0, change:0 }; }
      }

      async function fetchOpportunities() {
        try {
          const url = 'https://api.coingecko.com/api/v3/coins/markets?vs_currency=cad&order=price_change_percentage_24h_desc&per_page=100&page=1&price_change_percentage=24h';
          const data = await fetch(url).then(r => r.json());
          return data.filter(c => c.price_change_percentage_24h >= 20).slice(0,5)
                     .map(c => ({ sym: c.symbol.toUpperCase(), change: c.price_change_percentage_24h }));
        } catch { return []; }
      }

      function modifyAsset(add) {
        const [type,curr] = selType.value.split('_');
        let sym = inpSym.value.trim(); if (!sym) return alert('Symbole requis');
        sym = type === 'crypto' ? sym.toLowerCase() : sym.toUpperCase();
        const qty = parseFloat(inpQty.value);
        const inv = parseFloat(inpInv.value);
        if (add && (!qty || !inv)) return alert('Quantité et investi requis');
        const idx = portfolio.findIndex(a => a.type===type && a.sym===sym && a.curr===curr);
        if (add) {
          const entry = { type, sym, qty, inv, curr };
          idx > -1 ? portfolio[idx] = entry : portfolio.push(entry);
        } else if (idx > -1) {
          portfolio.splice(idx,1);
        }
        localStorage.setItem('portfolio', JSON.stringify(portfolio));
        refreshAll();
      }

      async function refreshAll() {
        tc.innerHTML = '';
        ta.innerHTML = '';
        tt.innerHTML = '';
        let invCAD=0, valCAD=0, invUSD=0, valUSD=0;
        const tops = [];

        for (const a of portfolio) {
          let price=0, change=0;
          if (a.type === 'crypto') {
            const o = await fetchCrypto(a.sym, a.curr);
            price  = o[a.curr] || 0;
            change = o[`${a.curr}_24h_change`] || 0;
          } else {
            const o = await fetchAction(a.sym);
            price  = o.price;
            change = o.change;
          }

          const value = price * a.qty;
          const gain  = value - a.inv;
          const pct   = a.inv ? ((gain / a.inv) * 100).toFixed(2) : '0.00';
          const reco  = change > 15 ? 'Renforcer' : change < -10 ? 'Vendre' : 'Garder';
          const cur   = a.curr.toUpperCase();
          const row   = `<tr><td>${a.sym.toUpperCase()}</td><td>${a.qty}</td><td>${a.inv.toFixed(2)} ${cur}</td><td>${price.toFixed(2)} ${cur}</td><td>${value.toFixed(2)} ${cur}</td><td class="${gain>=0?'gain':'perte'}">${gain.toFixed(2)} ${cur}</td><td class="${gain>=0?'gain':'perte'}">${pct}%</td><td>${reco}</td></tr>`;

          if (a.type === 'crypto') {
            tc.insertAdjacentHTML('beforeend', row);
            if (a.curr === 'cad') { invCAD += a.inv; valCAD += value; } else { invUSD += a.inv; valUSD += value; }
          } else {
            ta.insertAdjacentHTML('beforeend', row);
            if (a.curr === 'usd') { invUSD += a.inv; valUSD += value; } else { invCAD += a.inv; valCAD += value; }
          }

          if (change >= 20) tops.push({ sym: a.sym.toUpperCase(), change });
          if (change > 15 || change < -10) {
            OneSignal.sendSelfNotification(
              change > 15 ? 'Hausse forte' : 'Chute forte',
              `${a.sym.toUpperCase()} ${change.toFixed(2)}%`, null, null
            );
          }
        }

        if (!tops.length) tops.push(...await fetchOpportunities());

        res.innerHTML = `
          <strong>Résumé Global</strong>
          <p>Investi: ${invCAD.toFixed(2)} CAD | ${invUSD.toFixed(2)} USD</p>
          <p>Valeur: ${valCAD.toFixed(2)} CAD | ${valUSD.toFixed(2)} USD</p>
        `;
        last.textContent = `Mis à jour: ${new Date().toLocaleTimeString()}`;

        tops.sort((a,b) => b.change - a.change).slice(0,5).forEach(o => {
          tt.insertAdjacentHTML('beforeend', `<tr><td>${o.sym}</td><td>${o.change.toFixed(2)}%</td><td>24h</td></tr>`);
        });
      }

      refreshAll();
      setInterval(refreshAll, 120000);
    });
  </script></body>
</html>
