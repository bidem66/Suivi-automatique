<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=0.8">
  <title>Dashboard Portefeuille</title>
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 0; }
    .container { max-width: 800px; margin: 20px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #f4f4f4; }
    .gain { color: green; }
    .perte { color: red; }
    .controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    .controls > * { flex: 1 1 48%; }
    button { background: #007bff; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #0056b3; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Dashboard Portefeuille</h1>
    <div class="controls">
      <button id="refreshNow">Actualiser maintenant</button>
      <select id="typeAsset">
        <option value="crypto_cad">Crypto (CAD)</option>
        <option value="action_usd">Action (USD)</option>
      </select>
      <input id="symbol" placeholder="Symbole">
      <input id="quantity" type="number" placeholder="Quantité">
      <input id="invested" type="number" placeholder="Montant investi">
      <button id="addAsset">Ajouter</button>
      <button id="removeAsset">Supprimer</button>
    </div>

    <div id="resumeGlobal"></div>
    <div id="lastUpdate"></div>
    <table id="tableAssets">
      <thead>
        <tr><th>Symbole</th><th>Qté</th><th>Investi</th><th>Prix</th><th>Valeur</th><th>Gain</th><th>%</th><th>Reco</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <h3>Recommandations intelligentes</h3>
    <div id="opportunitesDetaillees"></div>
  </div>

  <script>
    const ALPHA_KEY = 'W9V75CXC1GIZ3HFX';
    const CG_IDS = { sol:'solana', ada:'cardano', link:'chainlink' };
    let portfolio = JSON.parse(localStorage.getItem('portfolio') || '[]');

    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async OneSignal => {
      await OneSignal.init({ appId: 'c5bd46ca-82c9-4493-b9a7-3813d3eccd03' });
    });

    function sendPushNotification(title, message) {
      OneSignalDeferred.push(async OneSignal => {
        await OneSignal.Notifications.sendWebNotification({
          title: title,
          message: message,
          url: window.location.href
        });
      });
    }

    async function fetchCrypto(sym, vs) {
      const id = CG_IDS[sym] || sym;
      const url = `https://api.coingecko.com/api/v3/simple/price?ids=${id}&vs_currencies=${vs}&include_24hr_change=true`;
      try { const data = await fetch(url).then(r => r.json()); return data[id] || {}; } catch { return {}; }
    }

    async function fetchAction(sym) {
      const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${sym}&apikey=${ALPHA_KEY}`;
      try {
        const data = await fetch(url).then(r => r.json());
        const g = data['Global Quote'] || {};
        return { price: parseFloat(g['05. price']) || 0, change: parseFloat(g['10. change percent']) || 0 };
      } catch { return { price: 0, change: 0 }; }
    }

    async function refreshAll() {
      const table = document.querySelector('#tableAssets tbody');
      table.innerHTML = '';
      const sentAlerts = JSON.parse(sessionStorage.getItem('sentAlerts') || '[]');
      let inv = 0, val = 0;

      for (const a of portfolio) {
        let price = 0, change = 0;
        if (a.type === 'crypto') {
          const o = await fetchCrypto(a.sym, a.curr);
          price = o[a.curr] || 0;
          change = o[`${a.curr}_24h_change`] || 0;
        } else {
          const o = await fetchAction(a.sym);
          price = o.price;
          change = o.change;
        }

        const value = price * a.qty;
        const gain = value - a.inv;
        const pct = a.inv ? (gain / a.inv * 100).toFixed(2) : '0.00';

        let reco = 'Garder';
        if (change > 15) {
          reco = 'Renforcer';
          const key = `reinforce_${a.sym}`;
          if (!sentAlerts.includes(key)) {
            sendPushNotification('Renforcer', `${a.sym.toUpperCase()} est en forte hausse (>15%)`);
            sentAlerts.push(key);
          }
        } else if (change < -10) {
          reco = 'Vendre';
          const key = `sell_${a.sym}`;
          if (!sentAlerts.includes(key)) {
            sendPushNotification('Vendre', `${a.sym.toUpperCase()} chute fortement (< -10%)`);
            sentAlerts.push(key);
          }
        }

        table.insertAdjacentHTML('beforeend', `<tr><td>${a.sym}</td><td>${a.qty}</td><td>${a.inv}</td><td>${price.toFixed(2)}</td><td>${value.toFixed(2)}</td><td class="${gain >= 0 ? 'gain' : 'perte'}">${gain.toFixed(2)}</td><td>${pct}%</td><td>${reco}</td></tr>`);
        inv += a.inv;
        val += value;
      }

      document.getElementById('resumeGlobal').innerHTML = `Investi: ${inv.toFixed(2)} | Valeur: ${val.toFixed(2)}`;
      document.getElementById('lastUpdate').textContent = `Mis à jour: ${new Date().toLocaleTimeString()}`;
      sessionStorage.setItem('sentAlerts', JSON.stringify(sentAlerts));
    }

    function modifyAsset(add) {
      const [type, curr] = document.getElementById('typeAsset').value.split('_');
      const sym = document.getElementById('symbol').value.trim();
      const qty = parseFloat(document.getElementById('quantity').value);
      const inv = parseFloat(document.getElementById('invested').value);
      if (!sym || !qty || !inv) return alert('Champs requis.');
      const idx = portfolio.findIndex(a => a.sym === sym && a.type === type && a.curr === curr);
      if (add) {
        const entry = { type, sym, qty, inv, curr };
        idx > -1 ? portfolio[idx] = entry : portfolio.push(entry);
      } else {
        if (idx > -1) portfolio.splice(idx, 1);
      }
      localStorage.setItem('portfolio', JSON.stringify(portfolio));
      refreshAll();
    }

    document.getElementById('refreshNow').onclick = refreshAll;
    document.getElementById('addAsset').onclick = () => modifyAsset(true);
    document.getElementById('removeAsset').onclick = () => modifyAsset(false);

    refreshAll();
    setInterval(refreshAll, 300000);
  </script>
</body>
</html>
